作为内网搭建的两大必备神器,我们今天就来讲讲它的功能

## DHCP
DHCP(动态主机设置协议) 通常被应用在大型的局域网环境中,主要作用是集中的管理、分配IP地址. 可以说正是因为这个协议,才导致IP如此的盛行.只要进入到该内网的设备,都可以自动的获取到一个IP地址, 而且对用户来说,是无感知,透明的.

这里我们主要了解两个方面, 1.它是如何运作的? 2.为什么是基于UDP协议

### DHCP的四次通讯
![DHCP](https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/DHCP_session.svg/800px-DHCP_session.svg.png)

我们通过进行一次抓包来演示:  
![DHCP Discover](pic/dhcp_connect.png)

第一步(Discover):  
在跟dhcp通讯时,我们此刻时没有IP地址的,所以用`(0.0.0.0)`来代替. 然后对于DHCP地址,我们也是不知道的,我们用`(255.255.255.255)`来代替,表示**广播查询**  
广播查询这个词很关键, 你想想,当你刚到一个办公室时,你没钥匙开门, 你肯定需要“广播”问一遍所有人, 查询谁负责开门的. 但“广播”这个词跟TCP是格格不入的,因为TCP是端对端的通讯.所以你需要“一个个”去询问,每次询问还要建立三次握手.这也太麻烦了

再来看下一个关键词, `Broadcast flag: Unicast(Broadcast`. 它表示当dhcp收到时,是以单播(一对一)的形式回复还是广播  

最后一个关键词是, `Client MAC address: xxxxx`. 这也是最重要的一个, 你想啊, 你在没有IP地址的情况下, DHCP是如何找到你的呢? 你可以说,DHCP可以再次通过广播找到我, 但如果此时有两个台机器都在申请IP地址呢?, 你如何确定是发给哪个人的.   
MAC地址就体现除出了作用(因为它是全球唯一标识, 全球只此一家,别无分店), 同时它也是第两层通讯的保证(链路层)

总结下第一步: 我们用了个默认地址, 对“所有人”发送一个广播,宣传我希望获得一个IP地址, 同时告知了我的MAC地址(让DHCP能够找到我)

![DHCP Discover](pic/dhcp_offer.png)

第二步(Offer)
当DHCP收到后, 它就会给你一个回包, 这里面包含
- IP地址
- 网关地址
- DNS服务器地址
- 过期时间

第三步(Request):
如果你注意看图,你会发现第三步的时候,这台机器还没用上DHCP所给的IP地址,然后发送方式还是广播(是因为害羞么?)  
当然不是, 你想, 假如你公司内有两台DHCP,而且都同时给它发送了新IP地址, 它需要通过广播去告知两台服务器, 对于征用的服务器, 它告知我使用了你的IP地址,请确认. 对于非征用的, 它告知, 我已经使用其他人的IP地址了,请你收回你给我发的IP地址

第四步(ACK):  
服务器回复ACK,表示确认. 然后机器都会使用上它获得的IP地址进行之后的通讯.

### 网吧用的是DHCP协议吗?
网吧用的都不是DHCP,一般都是配置静态地址, 原因是因为 **监控困难**. 因为机器每次重启后收到的IP地址是不一样的, 查找起来会很麻烦,不方便定位.
